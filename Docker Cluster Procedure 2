# Node 1
sudo docker create\
 --name couchdb1\
 -p 5984:5984\
 -p 4369:4369\
 -p 9100:9100\
 -v /home/ubuntu/data/couchdb/etc:/opt/couchdb/etc/local.d\
 --env ERL_FLAGS="-setcookie \"a192aeb9904e6590849337933b000c99\"\ 
 -name \"couchdb@172.26.132.147\"
 -kernel inet_dist_listen_min 9100\
 -kernel inet_dist_listen_max 9200"\
 couchdb

# Node 2
sudo docker create\
 --name couchdb2\
 -p 5984:5984\
 -p 4369:4369\
 -p 9100:9100\
 -v /home/ubuntu/data/couchdb/etc:/opt/couchdb/etc/local.d\
 --env ERL_FLAGS="-setcookie \"a192aeb9904e6590849337933b000c99\"\
 -name \"couchdb@172.26.135.39\"
 -kernel inet_dist_listen_min 9100\
 -kernel inet_dist_listen_max 9200"\
 couchdb

# Node 3
sudo docker create\
 --name couchdb3\
 -p 5984:5984\
 -p 4369:4369\
 -p 9100:9100\
 -v /home/ubuntu/data/couchdb/etc:/opt/couchdb/etc/local.d\
 --env ERL_FLAGS="-setcookie \"a192aeb9904e6590849337933b000c99\"\
 -name \"couchdb@172.26.132.82\"
 -kernel inet_dist_listen_min 9100\
 -kernel inet_dist_listen_max 9200"\
 couchdb

# For each node

curl -X PUT http://admin:password@127.0.0.1:5984/_users

curl -X PUT http://admin:password@127.0.0.1:5984/_replicator

curl -X PUT http://admin:password@127.0.0.1:5984/_global_changes

curl -X POST -H "Content-Type: application/json" http://admin:password@127.0.0.1:5984/_cluster_setup -d '{"action": "enable_cluster", "bind_address":"0.0.0.0", "username": "admin", "password":"password", "node_count":"3"}'

# For instance 2
curl -X POST -H "Content-Type: application/json" http://admin:password@172.26.132.147:5984/_cluster_setup -d '{"action": "enable_cluster", "bind_address":"0.0.0.0", "username": "admin", "password":"password", "port": 5984, "node_count": "3", "remote_node": "172.26.135.39", "remote_current_user": "admin", "remote_current_password": "password" }'

curl -X POST -H "Content-Type: application/json" http://admin:password@172.26.132.147:5984/_cluster_setup -d '{"action": "add_node", "host":"172.26.135.39", "port": 5984, "username": "admin", "password":"password"}'

# For instance 3
curl -X POST -H "Content-Type: application/json" http://admin:password@172.26.132.147:5984/_cluster_setup -d '{"action": "enable_cluster", "bind_address":"0.0.0.0", "username": "admin", "password":"password", "port": 5984, "node_count": "3", "remote_node": "172.26.132.82", "remote_current_user": "admin", "remote_current_password": "password" }'

curl -X POST -H "Content-Type: application/json" http://admin:password@172.26.132.147:5984/_cluster_setup -d '{"action": "add_node", "host":"172.26.132.82", "port": 5984, "username": "admin", "password":"password"}'

# Finish the clustering
curl -X POST -H "Content-Type: application/json" http://admin:password@172.26.132.147:5984/_cluster_setup -d '{"action": "finish_cluster"}'

# Verify install
curl http://admin:password@172.26.132.147:5984/_cluster_setup

# Membership
curl http://admin:password@127.0.0.1:5984/_membership


#
#Node 2
curl -X PUT "http://admin:password@localhost:5984/_node/_local/_nodes/couchdb@172.26.135.39" -d {}
#Node 3
curl -X PUT "http://admin:password@localhost:5984/_node/_local/_nodes/couchdb@172.26.132.82" -d {}

